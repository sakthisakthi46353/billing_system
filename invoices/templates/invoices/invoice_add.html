{% extends "base.html" %}
{% block content %}

<form method="post">
{% csrf_token %}

<div class="container mt-4">

  <!-- Header -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="mb-3">Create Invoice</h3>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Customer</label>
          <select name="customer" class="form-select" required>
            <option value="">-- Select --</option>
            {% for c in customers %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Invoice Date</label>
          <input type="date" name="date" class="form-control">
        </div>

        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="UNPAID">UNPAID</option>
            <option value="PARTIALLY_PAID">PARTIALLY PAID</option>
            <option value="PAID">PAID</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Items -->
  <div class="card shadow-sm">
    <div class="card-body">

      <h5 class="mb-3">Items</h5>

      <table class="table table-bordered text-center" id="itemsTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Tax %</th>
            <th>Discount</th>
            <th>Line Total</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>1</td>

            <td>
              <select name="product" class="form-select product">
                <option value="">-- Select --</option>
                {% for p in products %}
                  <option value="{{ p.id }}" data-price="{{ p.price }}">
                    {{ p.name }}
                  </option>
                {% endfor %}
              </select>
            </td>

            <td>
              <input type="number" name="quantity" class="form-control qty" value="1">
            </td>

            <td>
              <input type="number" name="unit_price" class="form-control price" value="0">
            </td>

            <td>
              <input type="number" name="tax_percent" class="form-control tax" value="0">
            </td>

            <td>
              <div class="input-group">
                <select name="discount_type" class="form-select discount-type">
                  <option value="percent">%</option>
                  <option value="amount">â‚¹</option>
                </select>
                <input type="number" name="discount_value" class="form-control discount" value="0">
              </div>
            </td>

            <td>
              <input type="text" class="form-control line-total" value="0.00" readonly>
            </td>

            <td>
              <button type="button" class="btn btn-danger btn-sm delete-row">âœ–</button>
            </td>
          </tr>
        </tbody>
      </table>

      <button type="button" class="btn btn-outline-primary" id="addRow">
        âž• Add Item
      </button>

      <!-- GRAND TOTAL -->
      <div class="row justify-content-end mt-4">
        <div class="col-md-4">
          <table class="table">
            <tr class="table-light fw-bold">
              <th>Grand Total</th>
              <td class="text-end" id="grandTotal">0.00</td>
            </tr>
          </table>
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-success">ðŸ’¾ Create Invoice</button>
        <a href="{% url 'invoices:invoice_list' %}" class="btn btn-secondary">Cancel</a>
      </div>

    </div>
  </div>
</div>
</form>

<script>
function calculateRow(row){
  let qty = +row.querySelector(".qty").value || 0;
  let price = +row.querySelector(".price").value || 0;
  let tax = +row.querySelector(".tax").value || 0;
  let discount = +row.querySelector(".discount").value || 0;
  let dtype = row.querySelector(".discount-type").value;

  let base = qty * price;
  if(dtype === "percent"){
    base -= base * (discount / 100);
  }else{
    base -= discount;
  }

  let total = base + (base * tax / 100);
  row.querySelector(".line-total").value = total.toFixed(2);
}

function calculateGrand(){
  let grand = 0;
  document.querySelectorAll(".line-total").forEach(i=>{
    grand += +i.value || 0;
  });
  document.getElementById("grandTotal").innerText = grand.toFixed(2);
}

document.addEventListener("change", e=>{
  if(e.target.classList.contains("product")){
    let row = e.target.closest("tr");
    row.querySelector(".price").value =
      e.target.selectedOptions[0].dataset.price || 0;
  }
  if(e.target.closest("tr")){
    calculateRow(e.target.closest("tr"));
    calculateGrand();
  }
});

document.addEventListener("input", e=>{
  if(e.target.closest("tr")){
    calculateRow(e.target.closest("tr"));
    calculateGrand();
  }
});

document.getElementById("addRow").onclick = ()=>{
  let tbody = document.querySelector("#itemsTable tbody");
  let row = tbody.rows[0].cloneNode(true);

  row.querySelectorAll("input").forEach(i=>i.value=0);
  row.querySelector(".qty").value=1;
  row.querySelector(".product").selectedIndex=0;
  row.querySelector(".line-total").value="0.00";

  tbody.appendChild(row);
};

document.addEventListener("click", e=>{
  if(e.target.classList.contains("delete-row")){
    let tbody = document.querySelector("#itemsTable tbody");
    if(tbody.rows.length > 1){
      e.target.closest("tr").remove();
      calculateGrand();
    }
  }
});
</script>

{% endblock %}
